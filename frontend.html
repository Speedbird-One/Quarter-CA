<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SME Financial Statement Analyzer — Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS to parse Excel/PDF in-browser -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
  <div class="max-w-6xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-indigo-700 mb-4">SME Financial Statement Analyzer — Demo</h1>
    <p class="text-sm text-slate-600 mb-6">Upload a simple Excel/PDF containing P&L, Balance Sheet, or Cash Flow lines (or use sample data).</p>

    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="md:col-span-2 bg-white p-4 rounded-lg shadow">
        <label class="block mb-2 font-medium">Upload Excel (.xlsx) or PDF</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.PDF" class="mb-3" />
        <button id="useSample" class="bg-indigo-600 text-white px-4 py-2 rounded mr-2">Use Sample Data</button>
        <button id="clearBtn" class="bg-gray-200 px-4 py-2 rounded">Clear</button>

        <div id="rawPreview" class="mt-4 text-sm text-slate-600"></div>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="font-semibold mb-2">Financial Passport</h2>
        <canvas id="passportCanvas" width="160" height="160"></canvas>
        <div class="mt-3">
          <div>Score: <span id="passportScore" class="font-bold text-indigo-600">-</span>/100</div>
          <div>Grade: <span id="passportGrade" class="font-semibold" id="grade">-</span></div>
        </div>
      </div>
    </div>

    <!-- Summary cards -->
    <div class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-slate-500">Revenue</div>
        <div id="revVal" class="text-xl font-semibold">-</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-slate-500">EBITDA</div>
        <div id="ebitdaVal" class="text-xl font-semibold">-</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-slate-500">Net Profit (PAT)</div>
        <div id="patVal" class="text-xl font-semibold">-</div>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <div class="text-sm text-slate-500">Cash & Equivalents</div>
        <div id="cashVal" class="text-xl font-semibold">-</div>
      </div>
    </div>

    <!-- Ratios and Benchmark -->
    <div class="grid md:grid-cols-2 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">Calculated Ratios</h3>
        <ul class="text-sm space-y-2 text-slate-700">
          <li>Current Ratio: <strong id="currentRatio">-</strong></li>
          <li>Debt-to-Equity: <strong id="deRatio">-</strong></li>
          <li>Net Profit Margin: <strong id="npm">-</strong></li>
          <li>EBIT Margin: <strong id="ebitMargin">-</strong></li>
          <li>Operating Cash Flow: <strong id="opCash">-</strong></li>
        </ul>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-3">Peer Benchmark (Industry Avg)</h3>
        <canvas id="benchmarkChart"></canvas>
        <div class="text-xs text-slate-500 mt-2">Benchmarks are sample values (replace with your dataset).</div>
      </div>
    </div>

    <!-- What-if Simulation -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h3 class="font-semibold mb-3">What-If Simulation</h3>
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-sm text-slate-600">Sales growth (%)</label>
          <input id="salesGrowth" type="range" min="-50" max="200" value="0" class="w-full" />
          <div class="text-sm mt-1">Change: <span id="salesPct">0</span>%</div>
        </div>
        <div>
          <label class="block text-sm text-slate-600">Repay Debt (absolute, ₹)</label>
          <input id="repayDebt" type="number" class="w-full border rounded px-2 py-1" placeholder="0" />
        </div>
        <div>
          <button id="runSim" class="bg-indigo-600 text-white px-4 py-2 rounded">Run Simulation</button>
        </div>
      </div>

      <div id="simResult" class="mt-4 hidden">
        <div>New Passport Score: <span id="simScore" class="font-bold text-indigo-600"></span></div>
        <div class="text-sm text-slate-700 mt-1" id="simText"></div>
      </div>
    </div>

    <!-- Diagnostics / mapping -->
    <div class="bg-white p-4 rounded shadow">
      <h3 class="font-semibold mb-2">Upload Diagnostics</h3>
      <p class="text-sm text-slate-600 mb-2">I try to auto-detect common labels. If your file uses different names, the analyzer may miss values. Keys I look for:</p>
      <ul class="text-sm text-slate-700">
        <li>- Revenue, Sales, Total Revenue</li>
        <li>- EBITDA, Operating Profit, EBIT</li>
        <li>- Net Profit, PAT, Profit After Tax</li>
        <li>- Current Assets, Current Liabilities</li>
        <li>- Total Debt, Debt, Interest Bearing Debt</li>
        <li>- Shareholders' Equity, Equity</li>
        <li>- Cash, Cash & Cash Equivalents</li>
        <li>- Operating Cash Flow, Cash from Operations</li>
      </ul>
    </div>
  </div>

  <script>
    // ------------- Utilities --------------
    function fmt(n){
      if(n === null || n === undefined || isNaN(n)) return '-';
      const abs = Math.abs(n);
      if(abs >= 1e9) return (n/1e9).toFixed(2) + 'B';
      if(abs >= 1e6) return (n/1e6).toFixed(2) + 'M';
      if(abs >= 1e3) return (n/1e3).toFixed(2) + 'K';
      return n.toFixed(2);
    }
    function toNumber(v){
      if(v === undefined || v === null) return NaN;
      if(typeof v === 'number') return v;
      // remove commas, currency signs, parentheses for negative
      const s = String(v).replace(/[\s₹,$]/g,'').replace(/\((.*?)\)/,'-$1');
      return Number(s);
    }

    // ------------- Sample Data --------------
    const SAMPLE = {
      revenue: 5000000,
      ebitda: 800000,
      ebit: 600000,
      pat: 350000,
      current_assets: 1200000,
      current_liabilities: 700000,
      total_debt: 1500000,
      equity: 2000000,
      cash: 300000,
      op_cash_flow: 250000
    };

    // ------------- State --------------
    let state = { ...SAMPLE }; // default
    let benchmarks = {
      // sample industry averages - replace with real dataset
      current_ratio: 1.5,
      debt_equity: 1.2,
      net_profit_margin: 0.08,
      ebit_margin: 0.12
    };

    // ------------- Charts --------------
    let passportChart = null;
    let benchChart = null;

    function initCharts(){
      // passport
      const pc = document.getElementById('passportCanvas').getContext('2d');
      passportChart = new Chart(pc, {
        type: 'doughnut',
        data: {
          labels:['Score','Remaining'],
          datasets:[{
            data:[0,100],
            backgroundColor: ['#4f46e5','#e6e6e6'],
            cutout:'75%'
          }]
        },
        options:{plugins:{legend:{display:false}}}
      });

      // benchmark
      const bc = document.getElementById('benchmarkChart').getContext('2d');
      benchChart = new Chart(bc, {
        type: 'bar',
        data: {
          labels:['Current Ratio','Debt/Equity','Net Profit Margin','EBIT Margin'],
          datasets:[
            { label: 'You', data: [0,0,0,0], backgroundColor:'#4f46e5' },
            { label: 'Industry Avg', data: [benchmarks.current_ratio,benchmarks.debt_equity,benchmarks.net_profit_margin,benchmarks.ebit_margin], backgroundColor:'#9ca3af' }
          ]
        },
        options: { responsive: true, scales: { y:{ beginAtZero:true } } }
      });
    }

    // ------------- Core Analyzer --------------
    function computeRatios(s){
      const ratios = {};
      ratios.current_ratio = safeDiv(s.current_assets, s.current_liabilities);
      ratios.debt_equity = safeDiv(s.total_debt, s.equity);
      ratios.net_profit_margin = safeDiv(s.pat, s.revenue);
      ratios.ebit_margin = safeDiv(s.ebit, s.revenue);
      ratios.op_cash = s.op_cash_flow ?? NaN;
      return ratios;
    }

    function safeDiv(a,b){ a = Number(a); b = Number(b); if(isNaN(a) || isNaN(b) || b === 0) return NaN; return a/b; }

    // Passport scoring: normalized sub-scores (0..100) with weights
    function computePassportScore(r){
      // normalize functions - these map ratio values to 0..100
      function normCurrent(x){
        if(isNaN(x)) return 50;
        // ideal 1.5 .. 3.0
        if(x >= 3) return 100;
        if(x <= 0.5) return 0;
        return (x - 0.5) / (3 - 0.5) * 100;
      }
      function normDebtEquity(x){
        if(isNaN(x)) return 50;
        // lower is better. map 0 -> 100, 0.5 -> 90, 2 -> 20, 4 -> 0
        if(x <= 0.5) return 95;
        if(x >= 4) return 0;
        return (1 - (x / 4)) * 100;
      }
      function normProfitMargin(x){
        if(isNaN(x)) return 50;
        // 0% -> 0, 0.05 -> 50, 0.2 -> 100
        if(x <= 0) return 10;
        if(x >= 0.2) return 100;
        return (x / 0.2) * 100;
      }
      const liq = normCurrent(r.current_ratio);
      const lev = normDebtEquity(r.debt_equity);
      const prof = normProfitMargin(r.net_profit_margin);

      // weights: liquidity 40%, profitability 30%, leverage 30%
      const score = (0.4*liq + 0.3*prof + 0.3*lev);
      return Math.max(0, Math.min(100, score));
    }

    function gradeFromScore(s){
      if(s >= 80) return {label:'Excellent', color:'text-emerald-600'};
      if(s >= 60) return {label:'Good', color:'text-amber-600'};
      if(s >= 40) return {label:'Moderate', color:'text-yellow-700'};
      return {label:'Risky', color:'text-red-600'};
    }

    // update UI from state
    function refreshUI(){
      // compute ratios
      const r = computeRatios(state);

      // summary values
      document.getElementById('revVal').textContent = state.revenue ? '₹ ' + fmt(state.revenue) : '-';
      document.getElementById('ebitdaVal').textContent = state.ebitda ? '₹ ' + fmt(state.ebitda) : '-';
      document.getElementById('patVal').textContent = state.pat ? '₹ ' + fmt(state.pat) : '-';
      document.getElementById('cashVal').textContent = state.cash ? '₹ ' + fmt(state.cash) : '-';

      // ratios
      document.getElementById('currentRatio').textContent = isNaN(r.current_ratio) ? '-' : r.current_ratio.toFixed(2);
      document.getElementById('deRatio').textContent = isNaN(r.debt_equity) ? '-' : r.debt_equity.toFixed(2);
      document.getElementById('npm').textContent = isNaN(r.net_profit_margin) ? '-' : (r.net_profit_margin*100).toFixed(2) + '%';
      document.getElementById('ebitMargin').textContent = isNaN(r.ebit_margin) ? '-' : (r.ebit_margin*100).toFixed(2) + '%';
      document.getElementById('opCash').textContent = r.op_cash ? '₹ ' + fmt(r.op_cash) : '-';

      // passport
      const score = computePassportScore(r);
      document.getElementById('passportScore').textContent = score.toFixed(1);
      const g = gradeFromScore(score);
      const gradeEl = document.getElementById('passportGrade');
      gradeEl.textContent = g.label;
      gradeEl.className = 'font-semibold ' + g.color;

      // update charts
      passportChart.data.datasets[0].data = [score, 100-score];
      passportChart.update();

      // benchmark values - update your company dataset
      benchChart.data.datasets[0].data = [
        isNaN(r.current_ratio) ? 0 : r.current_ratio,
        isNaN(r.debt_equity) ? 0 : r.debt_equity,
        isNaN(r.net_profit_margin) ? 0 : r.net_profit_margin,
        isNaN(r.ebit_margin) ? 0 : r.ebit_margin
      ];
      benchChart.update();
    }

    // ------------- File parsing --------------
    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    document.getElementById('useSample').addEventListener('click', () => { state = { ...SAMPLE }; refreshUI(); showRaw('Using sample data'); });
    document.getElementById('clearBtn').addEventListener('click', () => { state = {}; refreshUI(); showRaw('Cleared'); });

    function showRaw(txt){ document.getElementById('rawPreview').textContent = txt; }

    function handleFile(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      const name = file.name.toLowerCase();
      reader.onload = function(ev){
        const data = ev.target.result;
        if(name.endsWith('.PDF')){
          const text = data;
          parsePDF(text);
        } else {
          // XLSX
          const wb = XLSX.read(data, {type:'binary'});
          // try to find a sheet containing 'profit' or 'income' or 'balance'
          const sheets = wb.SheetNames;
          let combined = {};
          sheets.forEach(sname => {
            const ws = wb.Sheets[sname];
            const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
            // parse simple two-column key-value style
            for(let r=0;r<aoa.length;r++){
              const row = aoa[r];
              if(row.length < 2) continue;
              const k = String(row[0]).trim();
              const v = row.slice(1).find(x => x !== '') ?? row[1];
              if(!k) continue;
              combined[k] = v;
            }
          });
          // try to map combined to state
          mapParsedToState(combined);
          showRaw('Parsed from Excel: ' + JSON.stringify(Object.keys(combined).slice(0,12)));
          refreshUI();
        }
      };
      if(name.endsWith('.PDF')) reader.readAsText(file);
      else reader.readAsBinaryString(file);
    }

    function parsePDF(text){
      // simple PDF: assume key,value rows or header+value columns
      const rows = text.split(/\r?\n/).map(r => r.split(',').map(c => c.trim()));
      const combined = {};
      // if header exists and numeric row exists, try header->values
      if(rows.length >= 2 && rows[0].some(h=>h) && rows[1].some(c=>/^\d/.test(c))){
        rows[0].forEach((h,i)=> combined[h] = rows[1][i]);
      } else {
        rows.forEach(r => {
          if(r.length>=2) combined[r[0]] = r[1];
        });
      }
      mapParsedToState(combined);
      showRaw('Parsed from PDF: ' + JSON.stringify(Object.keys(combined).slice(0,12)));
      refreshUI();
    }

    // mapping heuristics
    function mapParsedToState(obj){
      const mapKeys = {
        revenue: ['revenue','sales','total revenue','turnover','total sales'],
        ebitda: ['ebitda','ebitda (standalone)','ebitda (adj)','operating profit before depreciation'],
        ebit: ['ebit','operating profit','profit before interest and tax'],
        pat: ['net profit','pat','profit after tax','net income'],
        current_assets: ['current assets','curr assets','total current assets'],
        current_liabilities: ['current liabilities','curr liabilities','total current liabilities'],
        total_debt: ['total debt','debt','interest bearing debt','borrowings','total borrowings'],
        equity: ['equity','shareholders equity','net worth','total equity'],
        cash: ['cash','cash & equivalents','cash and cash equivalents','cash balance'],
        op_cash_flow: ['operating cash flow','cash from operations','cash flow from operating activities']
      };
      const newState = {};
      // invert keys for quick lookup
      const lowerKeys = {};
      Object.keys(obj).forEach(k=>{
        lowerKeys[String(k).toLowerCase().trim()] = obj[k];
      });

      function findValue(keylist){
        for(const alias of keylist){
          // direct match
          if(lowerKeys[alias] !== undefined) return lowerKeys[alias];
        }
        // try partial match
        for(const k of Object.keys(lowerKeys)){
          for(const alias of keylist){
            if(k.includes(alias)) return lowerKeys[k];
          }
        }
        return undefined;
      }

      for(const [field, aliases] of Object.entries(mapKeys)){
        const v = findValue(aliases);
        if(v !== undefined){
          const num = toNumber(v);
          if(!isNaN(num)) newState[field] = num;
        }
      }

      // If not many fields found, try to parse some numeric single values (heuristic)
      // merge with existing state
      state = { ...state, ...newState };
    }

    // ------------- Simulation --------------
    document.getElementById('salesGrowth').addEventListener('input', e=>{
      document.getElementById('salesPct').textContent = e.target.value;
    });

    document.getElementById('runSim').addEventListener('click', ()=>{
      // copy state
      const sim = { ...state };
      const growthPct = Number(document.getElementById('salesGrowth').value) / 100;
      const repay = Number(document.getElementById('repayDebt').value) || 0;

      // Apply sales growth: naive proportional change to revenue and margins
      if(!isNaN(sim.revenue)) sim.revenue = sim.revenue * (1 + growthPct);
      // assume EBITDA and EBIT scale with revenue proportionally (simple)
      if(!isNaN(sim.ebitda)) sim.ebitda = sim.ebitda * (1 + growthPct);
      if(!isNaN(sim.ebit)) sim.ebit = sim.ebit * (1 + growthPct);
      if(!isNaN(sim.pat)) sim.pat = sim.pat * (1 + growthPct);
      // repay debt reduces total_debt and reduces cash
      if(!isNaN(sim.total_debt)) sim.total_debt = Math.max(0, sim.total_debt - repay);
      if(!isNaN(sim.cash)) sim.cash = Math.max(0, sim.cash - repay);

      // recompute
      const r = computeRatios(sim);
      const newScore = computePassportScore(r);
      document.getElementById('simScore').textContent = newScore.toFixed(1);
      document.getElementById('simText').textContent = `Sales +${(growthPct*100).toFixed(1)}% and repay ₹${fmt(repay)} => Current ratio ${(r.current_ratio||0).toFixed(2)}, Debt/Equity ${(r.debt_equity||0).toFixed(2)}.`;
      document.getElementById('simResult').classList.remove('hidden');

      // also visually update passport chart momentarily (not changing base state)
      passportChart.data.datasets[0].data = [newScore, 100-newScore];
      passportChart.update();
    });

    // ------------- Init --------------
    initCharts();
    refreshUI();
    showRaw('Ready — load a file or use sample');

  </script>
</body>
</html>
